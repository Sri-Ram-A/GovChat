"use client";

import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { Card, CardContent, CardHeader } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Upload, FileText, MapPin, Camera, Brain } from "lucide-react";

import FormField from "@/components/reusables/FormField";
import FormSection from "@/components/reusables/FormSection";
import { REQUEST } from "@/services/api";
import type { MediaType, ComplaintCreatePayload, Department } from "@/types";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Label } from "@/components/ui/label";
import { cn } from "@/lib/utils";

export default function PostComplaintPage() {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [uploadingEvidence, setUploadingEvidence] = useState(false);
  const [draftComplaintId, setDraftComplaintId] = useState<number | null>(null);
  const [departments, setDepartments] = useState<Department[]>([]);
  const [aiSuggestions, setAiSuggestions] = useState<{
    confidence?: number;
    jurisdiction_name?: string;
    department_name?: string;
  } | null>(null);
  
  const [form, setForm] = useState<ComplaintCreatePayload>({
    title: "",
    description: "",
    department: 0,
    address_line_1: "",
    address_line_2: "",
    landmark: "",
    city: "",
    pincode: "",
  });

  const [files, setFiles] = useState<Array<{ file: File; media_type: MediaType }>>([]);

  /* ---------------- Fetch Departments ---------------- */
  useEffect(() => {
    REQUEST("GET", "admins/departments/")
      .then(setDepartments)
      .catch(console.error);
  }, []);

  /* ---------------- Get User Location ----------------*/
  function getUserLocation(): Promise<{ latitude: number; longitude: number }> {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject(new Error("Geolocation not supported"));
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          resolve({
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
          });
        },
        (error) => {
          reject(error);
        }
      );
    });
  }


/* ---------------- Upload Evidence & Get AI Suggestions ---------------- */
async function uploadEvidenceAndAnalyze() {
  if (files.length === 0) {
    alert("Please select a photo first");
    return;
  }

  // Check if geolocation is supported
  if (!navigator.geolocation) {
    alert("Geolocation is not supported by your browser");
    return;
  }

  setUploadingEvidence(true);

  // Get user location using geolocation API
  navigator.geolocation.getCurrentPosition(
    async (position) => {
      try {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;

        console.log("User location:", latitude, longitude);

        // Upload first image with location
        const firstImage = files[0];
        const fd = new FormData();
        fd.append("file", firstImage.file);
        fd.append("media_type", firstImage.media_type);
        fd.append("latitude", String(latitude));
        fd.append("longitude", String(longitude));

        const response = await REQUEST("POST", "citizens/evidence/upload/", fd, {
          isMultipart: true,
        });

        console.log("Response:", response);

        // Extract AI suggestions from response
        if (response && response.suggestions) {
          const suggestions = response.suggestions;

          // Store AI metadata
          setAiSuggestions({
            confidence: suggestions.confidence,
            jurisdiction_name: suggestions.jurisdiction_name,
            department_name: suggestions.department_name,
          });

          // Auto-fill form with AI suggestions 
          setForm({
            title: suggestions.title || "",
            description: suggestions.description || "",
            department: suggestions.department_id || 0,
            address_line_1: "", 
            address_line_2: suggestions.address_line_2 || "", 
            city: suggestions.city || "",
            pincode: suggestions.pincode || "",
          });

          // Store draft complaint ID
          setDraftComplaintId(response.draft_complaint_id);

          alert("Photo analyzed! Please review the auto-filled details below.");
        }
      } catch (error: any) {
        console.error("Evidence upload failed:", error);
        alert("Failed to upload and analyze photo. Please try again.");
      } finally {
        setUploadingEvidence(false);
      }
    },
    (error) => {
      // Geolocation error handler
      console.error("Geolocation error:", error);
      setUploadingEvidence(false);
    },
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    }
  );
}
  /* ---------------- Submit Final Complaint ---------------- */
  async function submitComplaint() {
    if (!draftComplaintId) {
      alert("Please upload a photo first");
      return;
    }

    setLoading(true);
    try {
      const payload = {
        title: form.title,
        description: form.description,
        department: form.department,
        address_line_1: form.address_line_1,
        address_line_2: form.address_line_2,
        city: form.city,
        pincode: form.pincode,
        draft_complaint_id: draftComplaintId,
      };

      await REQUEST("POST", "citizens/complaints/", payload);
      router.push("/citizen/complaints");
    } catch (error) {
      console.error("Complaint submission failed:", error);
      alert("Failed to submit complaint. Please try again.");
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="max-w-3xl mx-auto px-4 py-10 min-h-full">
      <div
        className={cn(
          "absolute inset-0 -z-10",
          "[background-size:20px_20px]",
          "[background-image:radial-gradient(#d4d4d4_1px,transparent_2px)]",
          "dark:[background-image:radial-gradient(#404040_1px,transparent_2px)]"
        )}
      />

      <div className="absolute inset-0 bg-white [mask-image:radial-gradient(ellipse_at_center,transparent_20%,black)] dark:bg-black -z-10" />

      <Card className="shadow-lg relative z-10">
        <CardHeader className="mb-8">
          <div className="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-secondary text-sm text-muted-foreground mb-4">
            <FileText className="h-4 w-4" />
            <span>New Complaint</span>
          </div>
          <h1 className="font-serif text-4xl md:text-5xl font-medium tracking-tight text-foreground mb-2 text-balance">
            Register a Complaint
          </h1>
          <p className="text-lg text-foreground max-w-2xl leading-relaxed">
            Upload a photo of the issue for AI-powered analysis and auto-fill. Review and submit your complaint.
          </p>
        </CardHeader>
        
        <CardContent className="space-y-8">
          {/* Evidence Upload - STEP 1 */}
          <FormSection title="Step 1: Upload Photo for Analysis" icon={<Camera />}>
            <div className="space-y-4">
              <input
                type="file"
                accept="image/*"
                className="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-primary-foreground hover:file:bg-primary/90"
                onChange={(e) => {
                  if (!e.target.files) return;
                  const uploaded = Array.from(e.target.files).map((f) => ({
                    file: f,
                    media_type: "image" as MediaType,
                  }));
                  setFiles(uploaded);
                }}
              />

              {files.length > 0 && (
                <div className="flex flex-wrap gap-2">
                  {files.map((f, i) => (
                    <Badge key={i} variant="secondary">
                      {f.media_type} • {f.file.name}
                    </Badge>
                  ))}
                </div>
              )}

              {/* ALWAYS SHOW THIS BUTTON when files are selected and not yet uploaded */}
              {files.length > 0 && !draftComplaintId && (
                <Button
                  className="w-full text-base"
                  onClick={uploadEvidenceAndAnalyze}
                  disabled={uploadingEvidence}
                >
                  {uploadingEvidence ? "Analyzing..." : "Upload & Analyze Photo"}
                </Button>
              )}

              {/* Success indicator with AI insights */}
              {draftComplaintId && aiSuggestions && (
                <div className="space-y-3">
                  <div className="p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                    <p className="text-sm font-medium text-green-800 dark:text-green-200 mb-2">
                      ✓ Photo analyzed successfully!
                    </p>
                  </div>
                  
                  {/* AI Insights Card */}
                  <div className="p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                    <div className="flex items-center gap-2 mb-3">
                      <Brain className="h-4 w-4 text-blue-600 dark:text-blue-400" />
                      <span className="text-sm font-semibold text-blue-900 dark:text-blue-100">
                        AI Analysis Results
                      </span>
                    </div>
                    
                    <div className="space-y-2 text-sm">
                      {aiSuggestions.confidence !== undefined && (
                        <div className="flex justify-between items-center">
                          <span className="text-blue-700 dark:text-blue-300">Confidence Score:</span>
                          <Badge 
                            variant={aiSuggestions.confidence >= 0.7 ? "default" : "secondary"}
                            className="font-mono"
                          >
                            {(aiSuggestions.confidence * 100).toFixed(0)}%
                          </Badge>
                        </div>
                      )}
                      
                      {aiSuggestions.department_name && (
                        <div className="flex justify-between items-center">
                          <span className="text-blue-700 dark:text-blue-300">Suggested Department:</span>
                          <span className="font-medium text-blue-900 dark:text-blue-100">
                            {aiSuggestions.department_name}
                          </span>
                        </div>
                      )}
                      
                      {aiSuggestions.jurisdiction_name && (
                        <div className="flex justify-between items-center">
                          <span className="text-blue-700 dark:text-blue-300">Jurisdiction:</span>
                          <span className="font-medium text-blue-900 dark:text-blue-100">
                            {aiSuggestions.jurisdiction_name}
                          </span>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}
            </div>
          </FormSection>

          {/* Complaint Information - STEP 2 */}
          <FormSection title="Step 2: Review & Edit Details" icon={<FileText />}>
            <div className="space-y-4">
              <FormField
                label="Complaint Title"
                value={form.title}
                onChange={(v) => setForm({ ...form, title: v })}
                required
              />
              <div className="space-y-2">
                <Label>Description</Label>
                <Textarea
                  placeholder="Explain the issue in detail..."
                  className="min-h-[100px]"
                  value={form.description}
                  onChange={(e) =>
                    setForm({ ...form, description: e.target.value })
                  }
                />
              </div>
            </div>
          </FormSection>

          {/* Location Details */}
          <FormSection title="Location Details" icon={<MapPin />}>
            <div className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <FormField
                  label="Address Line 1 (House/Building No.)"
                  placeholder="e.g., Flat 302, Building A"
                  value={form.address_line_1}
                  onChange={(v) => setForm({ ...form, address_line_1: v })}
                />
                
                <FormField
                  label="Address Line 2 (Street/Area)"
                  placeholder="Auto-filled from AI"
                  value={form.address_line_2}
                  onChange={(v) => setForm({ ...form, address_line_2: v })}
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <FormField
                  label="City"
                  value={form.city}
                  onChange={(v) => setForm({ ...form, city: v })}
                />

                <FormField
                  label="Pincode"
                  value={form.pincode}
                  onChange={(v) => setForm({ ...form, pincode: v })}
                />

                <div className="space-y-2">
                  <Label>Department</Label>
                  <Select
                    value={form.department ? String(form.department) : ""}
                    onValueChange={(value) =>
                      setForm({ ...form, department: Number(value) })
                    }
                  >
                    <SelectTrigger className="w-full h-11">
                      <SelectValue placeholder="Select department" />
                    </SelectTrigger>

                    <SelectContent>
                      {departments.map((d) => (
                        <SelectItem key={d.id} value={String(d.id)}>
                          {d.name}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>
            </div>
          </FormSection>

          {/* Submit Button - STEP 3 */}
          {draftComplaintId && (
            <Button
              className="w-full text-base h-12"
              onClick={submitComplaint}
              disabled={loading || !form.department || !form.title}
            >
              {loading ? "Submitting..." : "Submit Complaint"}
            </Button>
          )}

          {/* Info message if no draft yet */}
          {!draftComplaintId && (
            <div className="p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
              <p className="text-sm text-blue-800 dark:text-blue-200">
                ℹ️ Please upload and analyze a photo first to continue.
              </p>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}